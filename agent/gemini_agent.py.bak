import os
import re
import json
from google import genai
import dotenv

dotenv.load_dotenv()

client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))
MODEL = "gemini-2.5-flash"

def extract_json(text: str) -> str:
    """Extract first JSON object from model output."""
    text = text.replace("```json", "").replace("```", "").strip()
    match = re.search(r"\{.*\}", text, re.DOTALL)
    if not match:
        raise ValueError("No JSON object found in output")
    return match.group(0)

def build_prompt(services, alerts, mcp_base_url):
    state_summary = {
        "services": {s["id"]: s["status"] for s in services},
        "alerts": [{"id": a["id"], "msg": a["msg"], "severity": a["severity"]} for a in alerts]
    }

    return f"""
You are a sysadmin AI assistant.

Current system state:
{json.dumps(state_summary, indent=2)}

Your job:
Formulate a plan to address any issues.

Rules:
- Available actions:
  - infra.restart (requires 'service_id')
  - alert.resolve (requires 'alert_id')
- Prioritize CRITICAL alerts.
- Be conservative.
- Output ONLY valid JSON.

Return exactly this plan format:
{{
  "goal": "<high level goal>",
  "steps": [
    {{
      "action": "<action>",
      "mcp": "{mcp_base_url}",
      "params": {{ ... }}
    }}
  ]
}}

If no action is needed, return empty steps.
"""

def generate_plan(services: list, alerts: list, mcp_base_url: str) -> tuple[dict, str]:
    """Generates a plan using Gemini based on current state. Returns (plan_dict, prompt_str)."""
    prompt = build_prompt(services, alerts, mcp_base_url)
    
    try:
        response = client.models.generate_content(
            model=MODEL,
            contents=prompt
        )
        text = response.text.strip()
        clean_json = extract_json(text)
        return json.loads(clean_json), prompt
    except Exception as e:
        print(f"‚ùå LLM Error: {e}")
        return {"goal": "Error", "steps": []}, prompt
